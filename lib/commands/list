#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/../.." 2>/dev/null && pwd)"

LIB_DIR=""
for candidate in \
  "$ROOT_DIR/lib" \
  "$SCRIPT_DIR/../lib" \
  "${NOIR_BUILD_TOOLS_LIB:-}" \
  "$HOME/.local/lib/noir-build-tools" \
  "/usr/local/lib/noir-build-tools"; do
  if [[ -n "$candidate" && -f "$candidate/utils.sh" ]]; then
    LIB_DIR="$candidate"
    break
  fi
done

if [[ -z "$LIB_DIR" ]]; then
  echo "lib/utils.sh not found; set NOIR_BUILD_TOOLS_LIB" >&2
  exit 1
fi

source "$LIB_DIR/utils.sh"
source "$LIB_DIR/config.sh"

load_config

echo ""
echo -e "${BOLD}Circuits in noir-build.config.json:${NC}"
echo ""
printf "  %-20s %-30s %s\n" "NAME" "PATH" "BUDGET"
printf "  %-20s %-30s %s\n" "----" "----" "------"

jq -r '.circuits[] | [.name, .path, (.constraintBudget // "-")] | @tsv' "$CONFIG_FILE" | \
while IFS=$'\t' read -r name path budget; do
  [[ "$budget" != "-" ]] && budget=$(printf "%'d" "$budget")
  printf "  %-20s %-30s %s\n" "$name" "$path" "$budget"
done
echo ""
