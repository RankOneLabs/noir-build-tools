#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/../.." 2>/dev/null && pwd)"

# Resolve library directory
LIB_DIR=""
for candidate in \
  "$ROOT_DIR/lib" \
  "$SCRIPT_DIR/../lib" \
  "${NOIR_BUILD_TOOLS_LIB:-}" \
  "$HOME/.local/lib/noir-build-tools" \
  "/usr/local/lib/noir-build-tools"; do
  if [[ -n "$candidate" && -f "$candidate/utils.sh" ]]; then
    LIB_DIR="$candidate"
    break
  fi
done

if [[ -z "$LIB_DIR" ]]; then
  echo "lib/utils.sh not found; set NOIR_BUILD_TOOLS_LIB" >&2
  exit 1
fi

source "$LIB_DIR/utils.sh"
source "$LIB_DIR/config.sh"

TESTDATA_DIR="$LIB_DIR/testdata"

# Check Node.js
require_cmd node

# Install deps if needed (check for node_modules or package-lock.json update)
if [[ ! -d "$TESTDATA_DIR/node_modules" ]]; then
  log_info "Installing testdata dependencies..."
  (cd "$TESTDATA_DIR" && npm install --silent)
fi

# Run the generator
exec node "$TESTDATA_DIR/cli.mjs" "$@"
