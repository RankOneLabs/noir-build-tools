#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/../.." 2>/dev/null && pwd)"

LIB_DIR=""
for candidate in \
  "$ROOT_DIR/lib" \
  "$SCRIPT_DIR/../lib" \
  "${NOIR_BUILD_TOOLS_LIB:-}" \
  "$HOME/.local/lib/noir-build-tools" \
  "/usr/local/lib/noir-build-tools"; do
  if [[ -n "$candidate" && -f "$candidate/utils.sh" ]]; then
    LIB_DIR="$candidate"
    break
  fi
done

if [[ -z "$LIB_DIR" ]]; then
  echo "lib/utils.sh not found; set NOIR_BUILD_TOOLS_LIB" >&2
  exit 1
fi

source "$LIB_DIR/utils.sh"

CONFIG_FILE="noir-build.config.json"

if [[ -f "$CONFIG_FILE" ]]; then
  log_warn "$CONFIG_FILE already exists"
  exit 0
fi

cat > "$CONFIG_FILE" << 'EOF'
{
  "version": "1.0.0",
  "circuits": [
    {
      "name": "example",
      "displayName": "Example Circuit",
      "path": "circuits/example",
      "description": "An example circuit",
      "constraintBudget": 100000,
      "benchmarkRuns": 5
    }
  ],
  "paths": {
    "reports": "./reports",
    "verifiers": "./contracts/verifiers"
  },
  "backend": {
    "path": "bb"
  }
}
EOF

log_success "Created $CONFIG_FILE"
log_info "Edit the config file to define your circuits"
